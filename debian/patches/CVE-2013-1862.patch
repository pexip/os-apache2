Description: fix log file poisoning via mod_rewrite
Origin: upstream, http://svn.apache.org/viewvc?view=revision&revision=1482349
Bug-Ubuntu: https://bugs.launchpad.net/ubuntu/+source/apache2/+bug/1188069

Index: apache2-2.2.22/modules/mappers/mod_rewrite.c
===================================================================
--- apache2-2.2.22.orig/modules/mappers/mod_rewrite.c	2013-07-12 08:08:49.000000000 -0400
+++ apache2-2.2.22/modules/mappers/mod_rewrite.c	2013-07-12 08:28:34.254549021 -0400
@@ -493,11 +493,11 @@
 
     logline = apr_psprintf(r->pool, "%s %s %s %s [%s/sid#%pp][rid#%pp/%s%s%s] "
                                     "(%d) %s%s%s%s" APR_EOL_STR,
-                           rhost ? rhost : "UNKNOWN-HOST",
-                           rname ? rname : "-",
-                           r->user ? (*r->user ? r->user : "\"\"") : "-",
+                           rhost ? ap_escape_logitem(r->pool, rhost) : "UNKNOWN-HOST",
+                           rname ? ap_escape_logitem(r->pool, rname) : "-",
+                           r->user ? (*r->user ? ap_escape_logitem(r->pool, r->user) : "\"\"") : "-",
                            current_logtime(r),
-                           ap_get_server_name(r),
+                           ap_escape_logitem(r->pool, ap_get_server_name(r)),
                            (void *)(r->server),
                            (void *)r,
                            r->main ? "subreq" : "initial",
@@ -507,7 +507,7 @@
                            perdir ? "[perdir " : "",
                            perdir ? perdir : "",
                            perdir ? "] ": "",
-                           text);
+                           ap_escape_logitem(r->pool, text));
 
     nbytes = strlen(logline);
     apr_file_write(conf->rewritelogfp, logline, &nbytes);
